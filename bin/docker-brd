#!/usr/bin/env ruby
# build local image, run command, delete image
# to use options for `docker run` separate arguments with --
require 'shellwords'

def sh(*command)
  puts command.shelljoin
  system *command
  $?.exitstatus
end

image = "docker-brd"

# build
status = sh("docker", "build", "-t", image, ".")
exit status unless status == 0

# run + cleanup
split_at = ARGV.index("--")
options, argv = (split_at ? [ARGV[0...split_at], ARGV[split_at+1..-1]] : [[], argv])

begin
  exit sh("docker", "run", "-it", "--rm", *options, image, *argv)
ensure
  `docker rmi #{image}` # silent cleanup
end
